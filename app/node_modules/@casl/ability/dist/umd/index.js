!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("sift/sift.csp.min")):"function"==typeof define&&define.amd?define(["exports","sift/sift.csp.min"],t):t((e=e||self).casl={},e.sift)}(this,function(e,n){"use strict";function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(e,t,n){return(s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&o(i,n.prototype),i}).apply(null,arguments)}function t(e){var n="function"==typeof Map?new Map:void 0;return(t=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==n){if(n.has(e))return n.get(e);n.set(e,t)}function t(){return s(e,arguments,i(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),o(t,e)})(e)}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}n=n&&n.hasOwnProperty("default")?n.default:n;function u(e){return'Cannot execute "'+e.action+'" on "'+e.subjectName+'"'}var c=u,l=function(r){function e(e,t){var n;return void 0===t&&(t={}),(n=r.call(this,e)||this)._setMetadata(t),n.message=e||c(a(n)),n._customMessage=null,"function"==typeof Error.captureStackTrace&&(n.name=n.constructor.name,Error.captureStackTrace(a(n),n.constructor)),n}!function(e,t){e.prototype=Object.create(t.prototype),(e.prototype.constructor=e).__proto__=t}(e,r),e.setDefaultMessage=function(e){c=null===e?u:"string"==typeof e?function(){return e}:e},e.from=function(e){var t=new this("");return Object.defineProperty(t,"ability",{value:e}),t};var t=e.prototype;return t.setMessage=function(e){return this._customMessage=e,this},t.throwUnlessCan=function(e,t,n){if(!this.ability)throw new ReferenceError("Cannot throw FordiddenError without respective ability instance");var r=this.ability.relevantRuleFor(e,t,n);if(!r||r.inverted){this._setMetadata({action:e,subject:t,field:n,subjectName:this.ability.subjectName(t)});var i=r?r.reason:"";throw this.message=this._customMessage||i||c(this),this}},t._setMetadata=function(e){this.subject=e.subject,this.subjectName=e.subjectName,this.action=e.action,this.field=e.field},e}(t(Error));function p(e){return Array.isArray(e)?e:[e]}function f(e){if(!e||"string"==typeof e)return e;var t="object"==typeof e?e.constructor:e;return t.modelName||t.name}var h=/[-/\\^$+?.()|[\]{}]/g,d=/\.?\*+\.?/g,b=/\*+/,y=/\./g;function v(e,t,n){var r="*"===n[0]||"."===e[0]&&"."===e[e.length-1]?"+":"*",i=-1===e.indexOf("**")?"[^.]":".",o=e.replace(y,"\\$&").replace(b,i+r);return t+e.length===n.length?"(?:"+o+")?":o}function m(e,t,n){return"."!==e||"*"!==n[t-1]&&"*"!==n[t+1]?"\\"+e:e}var g=function(){function e(e){this.actions=e.actions||e.action,this.subject=e.subject,this.fields=e.fields&&0!==e.fields.length?p(e.fields):void 0,Object.defineProperty(this,"_fieldsPattern",{writable:!0}),this.inverted=!!e.inverted,this.conditions=e.conditions,Object.defineProperty(this,"_matches",{writable:!0,value:this.conditions?n(this.conditions):void 0}),this.reason=e.reason}var t=e.prototype;return t.matches=function(e){return!this._matches||("string"==typeof e?!this.inverted:this._matches(e))},t.isRelevantFor=function(e,t){return!this.fields||(t?this.matchesField(t):!this.inverted)},t.matchesField=function(e){return void 0===this._fieldsPattern&&(this._fieldsPattern=-1===this.fields.join("").indexOf("*")?null:function(e){var t=e.map(function(e){return e.replace(h,m).replace(d,v)}),n=1<t.length?"(?:"+t.join("|")+")":t[0];return new RegExp("^"+n+"$")}(this.fields)),null===this._fieldsPattern||-1!==e.indexOf("*")?-1!==this.fields.indexOf(e):this._fieldsPattern.test(e)},e}(),w="undefined"!=typeof Symbol?Symbol("private"):"__"+Date.now(),j={crud:["create","read","update","delete"]};function R(e,t){return e===t||Array.isArray(t)&&-1!==t.indexOf(e)}var O=function(){function e(e,t){void 0===t&&(t={}),Object.defineProperty(this,"subjectName",{value:t.subjectName||f}),this[w]={RuleType:t.RuleType||g,originalRules:e||[],hasPerFieldRules:!1,indexedRules:Object.create(null),mergedRules:Object.create(null),events:{},aliases:function(e){return JSON.parse(JSON.stringify(e))}(j)},this.update(e)}e.addAlias=function(e,t){if("manage"===e||R("manage",t))throw new Error('Cannot add alias for "manage" action because it represents any action');if(R(e,t))throw new Error("Attempt to alias action to itself: "+e+" -> "+t.toString());return j[e]=t,this};var t=e.prototype;return t.update=function(e){if(!Array.isArray(e))return this;var t={rules:e,ability:this};this.emit("update",t),this[w].originalRules=e.slice(0),this[w].mergedRules=Object.create(null);var n=this.buildIndexFor(e);return"production"!==process.env.NODE_ENV&&n.isAllInverted&&e.length&&console.warn("[casl]: Ability contains only inverted rules. That means user will not be able to do any actions. This will be changed to Error throw in the next major version"),this[w].indexedRules=n.rules,this[w].hasPerFieldRules=n.hasPerFieldRules,this.emit("updated",t),this},t.buildIndexFor=function(e){for(var t=Object.create(null),n=this[w].RuleType,r=!0,i=!1,o=0;o<e.length;o++){var s=new n(e[o]),a=this.expandActions(s.actions),u=p(s.subject),c=e.length-o-1;r=!(!r||!s.inverted),!i&&s.fields&&(i=!0);for(var l=0;l<u.length;l++){var f=u[l];t[f]=t[f]||Object.create(null);for(var h=0;h<a.length;h++){var d=a[h];t[f][d]=t[f][d]||Object.create(null),t[f][d][c]=s}}}return{isAllInverted:r,hasPerFieldRules:i,rules:t}},t.expandActions=function(e){for(var t=this[w].aliases,n=p(e),r=0;r<n.length;){var i=n[r++];t.hasOwnProperty(i)&&(n=n.concat(t[i]))}return n},t.can=function(e,t,n){if(n&&"string"!=typeof n)throw new Error("Ability.can expects 3rd parameter to be a string. See https://stalniy.github.io/casl/abilities/2017/07/21/check-abilities.html#checking-fields for details");var r=this.relevantRuleFor(e,t,n);return!!r&&!r.inverted},t.relevantRuleFor=function(e,t,n){for(var r=this.rulesFor(e,t,n),i=0;i<r.length;i++)if(r[i].matches(t))return r[i];return null},t.possibleRulesFor=function(e,t){var n=this.subjectName(t),r=this[w].mergedRules,i=n+"_"+e;return r[i]||(r[i]=this.mergeRulesFor(e,n)),r[i]},t.mergeRulesFor=function(r,e){var i=this[w].indexedRules;return[e,"all"].reduce(function(e,t){var n=i[t];return n?Object.assign(e,n[r],n.manage):e},[]).filter(Boolean)},t.rulesFor=function(e,t,n){var r=this.possibleRulesFor(e,t);return this[w].hasPerFieldRules?r.filter(function(e){return e.isRelevantFor(t,n)}):r},t.cannot=function(){return!this.can.apply(this,arguments)},t.throwUnlessCan=function(){var e;console.warn('\n      Ability.throwUnlessCan is deprecated and will be removed in 4.x version.\n      Please use "ForbiddenError.from(ability).throwUnlessCan(...)" instead.\n    '.trim()),(e=l.from(this)).throwUnlessCan.apply(e,arguments)},t.on=function(t,n){var r=this[w].events,i=!0;return r[t]||(r[t]=[]),r[t].push(n),function(){if(i){var e=r[t].indexOf(n);r[t].splice(e,1),i=!1}}},t.emit=function(e,t){var n=this[w].events[e];n&&n.slice(0).forEach(function(e){return e(t)})},function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,[{key:"rules",get:function(){return this[w].originalRules}}]),e}();function _(e){return![].concat(e).some(function(e){return"string"!=typeof e})}function x(e){return e&&"object"==typeof e}var F=function(){function e(e){this.rule=e}return e.prototype.because=function(e){return this.rule.reason=e,this},e}(),P=function(){function e(e){var t=(void 0===e?{}:e).subjectName,n=void 0===t?f:t;this.rules=[],this.subjectName=n}e.define=function(e,t){function n(){return new O(o.rules,r)}var r="function"==typeof e?{}:e,i=e===r?t:e,o=new this(r),s=i(o.can.bind(o),o.cannot.bind(o));return s&&"function"==typeof s.then?s.then(n):n()},e.extract=function(){var e=new this;return{can:e.can.bind(e),cannot:e.cannot.bind(e),rules:e.rules}};var t=e.prototype;return t.can=function(e,t,n,r){if(!_(e))throw new TypeError("AbilityBuilder#can expects the first parameter to be an action or array of actions");var i=[].concat(t).map(this.subjectName);if(!_(i))throw new TypeError("AbilityBuilder#can expects the second argument to be a subject name/type or an array of subject names/types");var o={actions:e,subject:i};return!Array.isArray(n)&&"string"!=typeof n||(o.fields=n),(x(r)||!o.fields&&x(n))&&(o.conditions=r||n),this.rules.push(o),new F(o)},t.cannot=function(){var e=this.can.apply(this,arguments);return e.rule.inverted=!0,e},e}();e.Ability=O,e.AbilityBuilder=P,e.ForbiddenError=l,e.Rule=g,e.RuleBuilder=F,Object.defineProperty(e,"__esModule",{value:!0})});
